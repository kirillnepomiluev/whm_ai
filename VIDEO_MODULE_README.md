# Модуль генерации видео

## Описание

Модуль генерации видео позволяет создавать короткие видео (5 секунд) на основе:
- Текстовых описаний (text2video)
- Изображений с текстовыми промтами (image2video)

Используется API Kling для генерации видео.

## Функциональность

### Генерация видео по тексту
- Генерация видео длительностью 5 секунд по текстовому описанию
- Поддержка команды `/video` в текстовых сообщениях
- Поддержка голосовых команд "создай видео" или "video"

### Генерация видео по изображению (НОВОЕ!)
- Генерация видео на основе загруженного изображения и текстового промта
- Поддержка команды `/video` с изображением
- Автоматическая конвертация изображения в base64 формат
- Использование API endpoint `/v1/videos/image2video`

### Общие возможности
- Автоматическое списание 200 токенов за каждое видео
- Скачивание и отправка видео в Telegram
- Отображение прогресса генерации с анимацией
- Оптимизация промтов через OpenAI

## Установка и настройка

### 1. Переменные окружения

Добавьте в файл `.env` следующие переменные:

```env
# Настройки Kling API для генерации видео
KLING_ACCESS_KEY=your_kling_access_key
KLING_SECRET_KEY=your_kling_secret_key
# Необязательный параметр: кастомный URL API Kling
KLING_API_URL=https://api.klingai.com
```

### 2. Получение API ключей Kling

1. Зарегистрируйтесь на сайте [Kling](https://kling.com)
2. Получите Access Key и Secret Key в личном кабинете
3. Добавьте Access Key в переменную окружения `KLING_ACCESS_KEY`
4. Добавьте Secret Key в переменную окружения `KLING_SECRET_KEY`

## Использование

### Текстовые команды

```
/video [описание видео]
```

Примеры:
- `/video кошка играет с мячиком`
- `/video красивый закат над морем`
- `/video анимированный логотип компании`

### Команды с изображением (НОВОЕ!)

1. Загрузите изображение в чат
2. В поле описания (caption) введите команду:

```
/video [описание желаемых движений/эффектов]
```

Примеры:
- Загрузите фото кота и напишите: `/video кот начинает бегать по комнате`
- Загрузите пейзаж и напишите: `/video облака начинают двигаться, листья колышутся`
- Загрузите портрет и напишите: `/video человек начинает улыбаться и моргать`

#### Требования к изображению:
- Поддерживаемые форматы: JPG, JPEG, PNG
- Максимальный размер: 10MB
- Минимальное разрешение: 300x300 пикселей  
- Соотношение сторон: от 1:2.5 до 2.5:1

### Голосовые команды

Произнесите в голосовом сообщении:
- "создай видео [описание]"
- "video [описание]"

### Ответы ассистента

Если ассистент отвечает с командой `/video`, она также будет обработана автоматически.

## Стоимость

- **200 токенов** за каждое сгенерированное видео
- Проверка баланса перед генерацией
- Автоматическое списание токенов при успешной генерации

## Технические детали

### Структура модуля

```
src/video/
├── video.module.ts              # Модуль NestJS
└── video.service/
    ├── video.service.ts         # Основной сервис
    └── video.service.spec.ts    # Тесты
```

### API Kling

#### Text2Video (генерация по тексту)
- **Эндпоинт**: `/v1/videos/text2video`
- **Модель**: kling-v1-6
- **Длительность**: 5 секунд
- **Соотношение сторон**: 1:1 (квадратное)
- **Режим**: std (стандартный)

#### Image2Video (генерация по изображению) - НОВОЕ!
- **Эндпоинт**: `/v1/videos/image2video`  
- **Модель**: kling-v1
- **Режим**: pro (профессиональный)
- **Длительность**: 5 секунд
- **Формат изображения**: base64 (без префикса data:image/...)
- **cfg_scale**: 0.5

#### Общие параметры
- **Аутентификация**: JWT токены (генерируются автоматически из Access Key и Secret Key)
- **Таймаут ожидания**: 5 минут (30 попыток по 10 секунд)

### Обработка ошибок

- Проверка наличия Access Key и Secret Key
- Генерация JWT токенов для каждого запроса
- Обработка ошибок сети
- Таймаут ожидания генерации (5 минут)
- Fallback отправки видео как документа при ошибках

## Интеграция с Telegram

Модуль интегрирован в `TelegramService` и поддерживает:

1. **Текстовые сообщения** с командой `/video`
2. **Голосовые сообщения** с командами "создай видео"
3. **Ответы ассистента** с командой `/video`
4. **Автоматическую проверку токенов**
5. **Отправку видео в чат**

## Логирование

Модуль ведет подробные логи:
- Начало генерации видео
- Статус обработки
- Успешное завершение
- Ошибки и их детали
- Размер скачанного видео

## Примеры использования

### Успешная генерация по тексту

```
Пользователь: /video летящий дракон
Бот: [показывает анимацию "ОПТИМИЗИРУЮ ЗАПРОС ..."]
Бот: [показывает анимацию "СОЗДАЮ ВИДЕО ..."]
Бот: [отправляет сгенерированное видео с подписью "Видео по запросу: 'летящий дракон'"]
```

### Успешная генерация по изображению (НОВОЕ!)

```
Пользователь: [загружает фото кота]
Пользователь: /video кот начинает играть с мячиком
Бот: [показывает анимацию "ОПТИМИЗИРУЮ ЗАПРОС ..."] 
Бот: [показывает анимацию "СОЗДАЮ ВИДЕО ..."]
Бот: [отправляет сгенерированное видео с подписью "Видео по изображению: 'кот начинает играть с мячиком'"]
```

### Недостаточно токенов

```
Пользователь: /video красивое видео
Бот: "На Вашем балансе недостаточно токенов для генерации.
     Для продолжения работы с ботом приобретите подписку..."
```

### Ошибки генерации

#### Пустой промт
```
Пользователь: /video
Бот: "Пожалуйста, укажите описание для генерации видео после команды /video"
```

#### Пустой промт с изображением
```
Пользователь: [загружает изображение]
Пользователь: /video
Бот: "Пожалуйста, укажите описание для генерации видео после команды /video"
```

#### Неподходящее изображение
```
Пользователь: [загружает слишком маленькое изображение]
Пользователь: /video движение воды
Бот: "Не удалось сгенерировать видео: [ошибка API]"
```

## Требования

- NestJS 8+
- Node.js 16+
- Access Key и Secret Key Kling
- Достаточный баланс токенов

## Поддержка

При возникновении проблем:
1. Проверьте правильность Access Key и Secret Key
2. Убедитесь в достаточном балансе токенов
3. Проверьте логи приложения
4. Убедитесь в стабильности интернет-соединения 