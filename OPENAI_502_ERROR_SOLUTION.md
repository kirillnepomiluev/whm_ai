# Решение проблемы "Run завершился со статусом: failed" в OpenAI

## Описание проблемы

При отправке файлов **ИЛИ текстовых сообщений** в Telegram бот и запросе на анализ с ассистентом OpenAI, система возвращает ошибку:

```
[Nest] WARN [OpenAiService] Run завершился со статусом: failed
[Nest] WARN [OpenAiService] Попытка 1 не удалась, повторяем через 1000ms
[Nest] WARN [OpenAiService] Error: Run завершился со статусом: failed
```

## Причины ошибки

1. **Проблемы с ассистентом**: Ассистент может быть недоступен или иметь ограничения
2. **Проблемы с тредом**: Тред может быть поврежден или иметь конфликты
3. **Проблемы с API**: Сетевые проблемы или недоступность OpenAI API
4. **Проблемы с форматом файла**: Некоторые форматы файлов могут не поддерживаться
5. **Размер файла**: Файлы больше 100MB не поддерживаются

## Внесенные улучшения

### 1. Детальное логирование

Добавлено детальное логирование для всех операций:
- Создание и проверка тредов
- Проверка доступности ассистента
- Логирование размера и формата файла
- Логирование процесса загрузки файла
- Детальная информация об ошибках Run

### 2. Улучшенная обработка ошибок

- Новый метод `getRunErrorDetails()` для получения детальной информации об ошибках
- Проверка доступности ассистента перед созданием Run
- Обработка различных статусов Run (failed, requires_action, expired)
- Более информативные сообщения об ошибках для пользователя
- Специфичные сообщения для разных типов ошибок

### 3. Валидация и очистка

- Проверка размера файла (максимум 100MB)
- Проверка поддерживаемых форматов файлов
- Автоматическая очистка поврежденных тредов при старте
- Проверка существования тредов перед использованием

### 4. Новые API endpoints

- **`GET /api/assistant/status`** - статус ассистента
- **`POST /api/threads/cleanup`** - очистка поврежденных тредов
- **`GET /api/threads/status`** - статус активных тредов
- **`GET /api/health`** - общее состояние системы

## Поддерживаемые форматы файлов

- `.pdf` - PDF документы
- `.txt` - Текстовые файлы
- `.docx` - Word документы (новые)
- `.doc` - Word документы (старые)
- `.rtf` - Rich Text Format
- `.odt` - OpenDocument Text

## Как использовать

### Для текстовых сообщений:
1. **Отправьте текстовое сообщение** в Telegram бот
2. **Дождитесь ответа** от ассистента

### Для файлов:
1. **Отправьте файл** в Telegram бот
2. **Добавьте описание** в подпись к файлу (опционально)
3. **Дождитесь ответа** от ассистента

## Диагностика проблем

### 1. Проверка статуса ассистента
```bash
GET /api/assistant/status
```

### 2. Проверка состояния тредов
```bash
GET /api/threads/status
```

### 3. Очистка поврежденных тредов
```bash
POST /api/threads/cleanup
```

### 4. Общий статус системы
```bash
GET /api/health
```

### 5. Проверка логов

При возникновении ошибки проверьте логи на наличие:
- Создания и проверки тредов
- Доступности ассистента
- Размера и формата файла
- Процесса загрузки в OpenAI
- Детальной информации об ошибке Run

## Примеры ошибок и решений

### Ошибка: "Run failed: file_size_exceeded"
**Решение**: Уменьшите размер файла или используйте другой формат

### Ошибка: "Run failed: unsupported_file_type"
**Решение**: Конвертируйте файл в поддерживаемый формат

### Ошибка: "Run failed: assistant_unavailable"
**Решение**: Проверьте доступность ассистента через `/api/assistant/status`

### Ошибка: "Run требует действия"
**Решение**: Переформулируйте вопрос или используйте более простой запрос

### Ошибка: "Run истек"
**Решение**: Отправьте сообщение еще раз

### Ошибка: "Тред поврежден"
**Решение**: Используйте `/api/threads/cleanup` для очистки

## Автоматические исправления

### При старте сервиса:
- Автоматическая проверка доступности API
- Очистка поврежденных тредов
- Проверка состояния ассистента

### При обработке запросов:
- Проверка существования тредов
- Создание новых тредов при необходимости
- Переключение на fallback API при ошибках

## Рекомендации

1. **Регулярно проверяйте статус** через `/api/health`
2. **Мониторьте логи** для выявления паттернов ошибок
3. **Используйте поддерживаемые форматы** файлов
4. **Ограничивайте размер файлов** до 100MB
5. **При повторных ошибках** используйте `/api/threads/cleanup`

## Контакты для поддержки

При возникновении проблем:
1. Проверьте логи приложения
2. Используйте диагностические endpoints
3. Обратитесь к администратору системы
4. Создайте issue в репозитории проекта
