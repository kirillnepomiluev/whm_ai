# Решение ошибки 502 Bad Gateway в OpenAI сервисе

## Описание проблемы

Ошибка 502 Bad Gateway возникает при обращении к прокси-серверу nginx, который не может получить ответ от backend-сервера (OpenAI API). В вашем случае это происходит при обращении к `https://chat.neurolabtg.ru/v1`.

## Причины ошибки

1. **Проблемы с прокси-сервером**: nginx не может подключиться к OpenAI API
2. **Сетевые проблемы**: блокировка на уровне провайдера или файрвола
3. **Недоступность API сервера**: сервер `chat.neurolabtg.ru` может быть недоступен
4. **Проблемы с конфигурацией**: неправильная настройка nginx

## Реализованное решение

### 1. Fallback API
Добавлен fallback на официальный OpenAI API (`https://api.openai.com/v1`) для случаев, когда основной API недоступен.

### 2. Retry логика
Реализована система повторных попыток с экспоненциальной задержкой:
- Автоматическое переключение на fallback при ошибке 502
- Повторные попытки для других типов ошибок
- Максимум 3 попытки с увеличивающейся задержкой

### 3. Мониторинг доступности API
- Автоматическая проверка доступности основного API каждые 5 минут
- Endpoints для мониторинга статуса API
- Логирование всех переключений между API

## Новые endpoints

### GET `/api/status`
Возвращает текущий статус API endpoints:
```json
{
  "mainApi": "https://chat.neurolabtg.ru/v1",
  "fallbackApi": "https://api.openai.com/v1",
  "isMainApiAvailable": false
}
```

### POST `/api/check-main-api`
Принудительно проверяет доступность основного API:
```json
{
  "success": true,
  "isMainApiAvailable": false,
  "message": "Основной API недоступен, используется fallback"
}
```

## Как это работает

1. **При старте**: создаются два OpenAI клиента (основной и fallback)
2. **При запросе**: система проверяет доступность основного API
3. **При ошибке 502**: автоматически переключается на fallback API
4. **Мониторинг**: каждые 5 минут проверяется доступность основного API
5. **Восстановление**: при восстановлении основного API система автоматически возвращается к нему

## Конфигурация

Убедитесь, что в вашем `.env` файле настроены следующие переменные:

```env
OPENAI_API_KEY_PRO=your_openai_api_key
OPENAI_BASE_URL_PRO=https://chat.neurolabtg.ru/v1
```

## Логирование

Система ведет подробные логи:
- `Основной OpenAI API доступен` - когда API работает
- `Основной OpenAI API недоступен, используем fallback` - при переключении
- `Получена ошибка 502, переключаемся на fallback API` - при ошибке 502

## Рекомендации

1. **Мониторинг**: регулярно проверяйте статус API через `/api/status`
2. **Логи**: анализируйте логи для понимания частоты переключений
3. **Сеть**: проверьте доступность `chat.neurolabtg.ru` с вашего сервера
4. **Провайдер**: свяжитесь с провайдером `chat.neurolabtg.ru` для выяснения причин недоступности

## Тестирование

Для проверки работы fallback системы:

1. Запустите приложение
2. Проверьте статус: `GET /api/status`
3. Принудительно проверьте API: `POST /api/check-main-api`
4. Отправьте запрос на генерацию изображения
5. Проверьте логи на наличие переключений между API

## Альтернативные решения

Если проблема с `chat.neurolabtg.ru` продолжается:

1. **Изменить основной URL** на другой прокси-сервер
2. **Использовать VPN** для обхода блокировок
3. **Настроить собственный прокси** для OpenAI API
4. **Перейти полностью** на официальный OpenAI API

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Используйте endpoints мониторинга
3. Проверьте сетевую доступность
4. Обратитесь к администратору `chat.neurolabtg.ru`
