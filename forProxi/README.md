# Инструкция по устранению ошибки 502 Bad Gateway при загрузке изображений

## Проблема
При загрузке изображений (фото) через прокси сервер возникает ошибка 502 Bad Gateway, хотя обычные запросы к OpenAI API работают нормально.

## Внесенные изменения

### 1. Основная конфигурация (neurolabtg.ru)
- **Увеличен размер тела запроса** с 50m до 100m для загрузки изображений
- **Улучшены настройки буферизации** для файлов (proxy_buffers, proxy_buffer_size)
- **Добавлены специальные заголовки** для multipart/form-data
- **Добавлен заголовок Content-Length** для корректной передачи размера файла
- **Увеличены таймауты** для загрузки файлов (300 секунд)
- **SSL проверка оставлена включенной** (так как другие запросы работают)

### 2. Специальная обработка изображений
- **Добавлен отдельный location блок** для файлов изображений (.jpg, .jpeg, .png, .gif, .webp)
- **Оптимизированы настройки** специально для загрузки изображений
- **Отключена буферизация** для предотвращения проблем с передачей файлов

### 3. Страница ошибок (50x.html)
- Создана красивая страница для отображения ошибок 50x
- Добавлена кнопка "Попробовать снова"

### 4. Резервная копия (neurolabtg.ru.backup)
- Сохранена оригинальная конфигурация

## Применение изменений

### Шаг 1: Проверка синтаксиса
```bash
sudo nginx -t
```

### Шаг 2: Перезагрузка nginx
```bash
sudo systemctl reload nginx
# или
sudo systemctl restart nginx
```

### Шаг 3: Проверка статуса
```bash
sudo systemctl status nginx
```

## Возможные причины ошибки 502 при загрузке изображений

1. **Размер файла** - решено увеличением client_max_body_size до 100m
2. **Буферизация** - отключена для предотвращения проблем с передачей
3. **Таймауты** - увеличены для обработки больших файлов
4. **Заголовки** - добавлены специальные заголовки для multipart/form-data
5. **Content-Length** - добавлен для корректной передачи размера файла

## Мониторинг

После применения изменений проверьте логи nginx:
```bash
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

## Откат изменений

Если проблемы остаются, можно вернуться к оригинальной конфигурации:
```bash
sudo cp neurolabtg.ru.backup neurolabtg.ru
sudo nginx -t
sudo systemctl reload nginx
```

## Дополнительные рекомендации

1. Убедитесь, что размер загружаемых изображений не превышает 100MB
2. Проверьте, что Content-Type корректно передается как multipart/form-data
3. Мониторьте использование памяти сервера при загрузке больших файлов
4. Рассмотрите возможность сжатия изображений перед загрузкой
5. Проверьте, что все необходимые заголовки передаются корректно
